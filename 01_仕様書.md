# Magic Link認証と学習プラットフォーム拡張 実装計画書

**計画作成日時**: 2025年07月09日 09:00:00
**対象ブランチ**: work
**計画者**: Codex AI

## 📋 目的
本ドキュメントは、SupabaseのMagic Link認証を中心とする会員システムと、レッスン・チャレンジ機能を備えたジャズ学習向けリズムゲームの実装計画をまとめたものである。ユーザー登録から管理画面、経験値システム、コミュニティ機能までを段階的に実装し、最小実用製品(MVP)を完成させることを目的とする。

## 🛠️ 技術スタック
- **フロントエンド**: React(TypeScript) + Vite
- **UIライブラリ**: shadcn/ui
- **フォーム管理**: React-Hook-Form + Zod
- **状態管理**: Zustand
- **バックエンド**: Supabase(PostgreSQL, Storage, Auth)
- **動画配信**: Vimeo
- **その他**: Netlify(ホスティング), Sentry(監視)

## ✨ 機能概要
1. **認証・アカウント管理**
   - Supabase Magic Linkによるメール認証
   - 会員登録時に利用規約・プライバシーポリシーへの同意を必須化
   - ニックネーム登録・編集機能
   - ゲスト用「おためし」プレイボタン
2. **ヘッダー・ナビゲーション**
   - 左端: トップページボタン
   - 右端: 会員登録/ログイン、ログイン後はアカウントモーダルボタン
   - アカウントボタン左にマイページボタンを配置
3. **会員ランク制度**
   - Free / Standard / Premium / Platinumの4段階
   - ランクに応じた経験値倍率やコンテンツ解放条件
   - 管理画面からランク変更可能
4. **管理画面**
   - 曲登録・編集ダッシュボード(JSONハードコーディングから移行)
   - レッスン・チャレンジ・ミッション管理
   - ユーザーの会員ランク編集
5. **経験値(XP)システム**
   - 本番モード(ステージ)終了時にXP取得
   - 会員ランク倍率: 1x / 1.5x / 2x
   - 再生速度・スコアランク・移調によるボーナス
   - レベルテーブル: Lv1-10=2000XP, Lv11-50=5000XP, Lv51+=20000XP
   - 結果画面で獲得XP・レベル変動を表示
   - 全期間レベルランキングを提供
6. **レッスン機能**
   - レッスン→コース→(動画|曲)の階層構造
   - 楽曲クリア条件: キー, 再生速度, スコアランク, 楽譜表示設定, クリア回数
   - Premium以上でレッスン解放、Platinumはスキップ可
   - プラチナ限定の課題提出(チェックボックス)機能
   - レッスン曲を本番モードでプレイするとXP2倍
7. **チャレンジ/ミッション**
   - 週次・月次の期間限定イベントを管理画面から作成
   - 条件達成状況をマイページで進捗バー表示
   - 達成報酬: 次シーズンXP1.3倍
   - 当月・前月のランキング表示(先着100名)
8. **マイページ**
   - 個別楽曲の記録(最高ランク、Bランク以上のクリア回数)
   - レッスン進捗、チャレンジ/ミッション進捗
   - 左側にレッスンボタンを配置
9. **コミュニティ(日記)機能**
   - 1日1記事の練習記録投稿、編集不可
   - コメント・いいね機能
   - ユーザーページで過去記事一覧を閲覧
10. **その他UI要素**
    - 経験値・レベルアップ演出
    - トップページにステージ一覧、チャレンジ、ミッションを表示

## 📑 データベース設計(抜粋)
- `users`: Supabase Auth標準テーブル
- `profiles`: `user_id`, `nickname`, `rank`, `xp`, `level`, `subscription_plan`
- `songs`: 楽曲情報(`id`, `title`, `artist`, `bpm`, `difficulty`, `is_free`)
- `song_settings`: 楽曲ごとのクリア条件
- `lessons`, `lesson_items`: レッスン階層を管理
- `challenges`, `challenge_tasks`: 週次・月次イベント
- `user_song_stats`: 各ユーザーの曲クリア状況
- `xp_logs`: XP取得履歴
- `diaries`, `diary_likes`, `diary_comments`: 日記・リアクション

## 🚧 実装フェーズ
1. **Phase 0: 環境整備 (1週間)**
   - Supabaseプロジェクト作成
2. **Phase 1: 認証基盤 (1週間)**
   - Magic Linkフロー実装、同意モーダル、ニックネーム登録
3. **Phase 2: 楽曲データベース化 (2週間)**
   - 既存JSONからPostgresへ移行、管理画面の曲CRUD
4. **Phase 3: XP & ランキング (1週間)**
   - XP計算ロジック、結果画面、レベルランキング
5. **Phase 4: レッスンシステム (2週間)**
   - 階層モデル実装、クリア条件・スキップ、XP2倍処理
6. **Phase 5: チャレンジ/ミッション (1週間)**
   - 進捗管理、報酬計算、ランキング
7. **Phase 6: コミュニティ (1週間)**
   - 日記投稿、いいね・コメント、ユーザーページ
8. **Phase 7: 管理画面拡張 (1週間)**
   - 会員ランク編集、イベント・レッスン管理
9. **Phase 8: QA & リリース準備 (1週間)**
   - E2Eテスト(Playwright)とユニットテスト(Vitest)
   - パフォーマンス最適化、バグ修正

合計見積もり: 約10週間

## ✅ 完了条件
- Magic Linkでのログイン/登録が動作し、ニックネーム設定まで行えること
- 管理画面から曲・レッスン・チャレンジを登録・編集できること
- 経験値計算とレベルアップが反映され、結果画面に表示されること
- ユーザーが日記を投稿し、コメント・いいねができること

## 📝 既知の課題と質問
- 決済(Stripe.js)の統合タイミングは未定
- フロントエンドフレームワークをNext.jsへ移行するか検討中
- Vimeo以外の動画ホスティングを採用する可能性
- 本番環境用ドメイン・SSL設定の時期

## ✍️ 更新履歴
- 2025-07-09 09:00:00: ドキュメント初版作成
