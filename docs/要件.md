# リズムモード 追加要件

本書はファンタジーモードに新規追加する「リズムモード」の要件をまとめたドキュメントである。

## 目的
1. 既存のクイズモードを保持したまま、演奏タイミングと判定ウィンドウを持つリズムゲーム要素を追加する。
2. コード演奏をリアルタイムに評価し、成功／失敗をゲーム進行と連動させる。

## 実装範囲
- フロントエンド
  - RhythmGameEngine（仮称）の新規実装
  - zustand-store での時間／カウントイン管理強化
  - UI 追加
- バックエンド
  - Supabase `fantasy_stages` テーブル既存カラムを流用。`mode = 'rhythm'` を追加。

## 要件一覧
1. 判定ウィンドウ
   - 目標時刻 ±200 ms を正解受付時間とする。
2. 攻撃成功／失敗
   - 成功で敵 HP を減少、失敗で敵攻撃。
   - 全敵 HP が 0 になるまで継続。
3. カウントインとループ
   - `count_in_measures` に従い初回のみカウントインを再生。
   - ループ時はカウントインをスキップし 2 小節目へ。
4. コード出題
   - ランダムパターン：`allowed_chords` から 1 小節 1 コード。
   - プログレッション：`chord_progression_data` がある場合、JSON で拍位置とともに決定。
5. 同時出現数
   - ランダム: 敵 1 体固定。
   - プログレッション: 拍子に合わせ 3 または 4 体固定。
6. UI 表示
   - 判定用 UI は内部ロジックのみで管理し、ユーザーには攻撃ゲージ等でフィードバック。
7. ステージカード
   - リズム or クイズ、ランダム or プログレッションを明記する。

---
最終的な仕様は詳細設計で補足する。