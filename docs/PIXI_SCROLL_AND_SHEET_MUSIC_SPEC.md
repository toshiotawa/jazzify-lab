# PIXIエリアスクロール機能と楽譜表示システム仕様

## 概要

このドキュメントは、Jazz Learning Gameにおける以下の2つの機能の仕様をまとめたものです：

1. PIXIエリア（ノーツ降下エリア）の横スクロール機能
2. 楽譜表示システム（SheetMusicDisplay）

## PIXIエリアスクロール機能

### 機能概要
- PIXIエリア内でマウスドラッグまたはタッチスワイプによる横スクロールが可能
- 慣性スクロール対応（ドラッグ終了後も速度に応じて継続）
- マウスホイールによるスクロールも対応
- 60FPS維持のための最適化実装

### 実装詳細

#### スクロールコンテナ構造
```
app.stage
├── scrollContainer（スクロール可能なコンテナ）
│   └── container（ノーツなどのコンテンツ）
├── hitLineContainer（判定ライン - スクロールしない）
├── pianoContainer（ピアノ鍵盤 - スクロールしない）
└── effectsContainer（エフェクト - スクロールしない）
```

#### 操作方法
1. **マウス/タッチドラッグ**
   - ドラッグ開始：カーソルが「grab」から「grabbing」に変化
   - ドラッグ中：リアルタイムでスクロール位置を更新
   - ドラッグ終了：慣性スクロール開始

2. **マウスホイール**
   - 垂直スクロールを水平スクロールに変換
   - スクロール速度係数：1.5

3. **慣性スクロール**
   - 摩擦係数：0.95（フレームごとに速度を5%減少）
   - 停止閾値：0.5px/frame

#### スクロール範囲
- 最小値：0（左端）
- 最大値：最も右にあるノートの位置 + 100px（右端余白）

### パフォーマンス最適化
- PIXI.Ticker.sharedを使用して60FPSを維持
- ノートドラッグ中はスクロールを無効化
- スクロール範囲は動的に更新（ノート追加時）

## 楽譜表示システム

### 機能概要
- MusicXMLファイルから楽譜を読み込み、横スクロール形式で表示
- JSONファイルのタイミングデータに基づいて自動スクロール
- プレイヘッド（赤い縦線）で現在の再生位置を表示

### 動作仕様

#### 楽譜とJSONの連動
1. **JSONファイル（demo-1.json）**
   - 音符の時刻（time）とピッチ（MIDIノート番号）を定義
   - 楽譜の自動スクロールタイミングの基準

2. **MusicXMLファイル（demo-1.xml）**
   - JSONの音符順序と一致する楽譜データ
   - 全て4分音符として記譜（BPMは無視）
   - 音高はJSONのpitch値から導出

#### スクロール動作
1. **タイムマッピング**
   - MusicXML内の各音符のX座標を取得
   - JSONの時刻データと対応付け
   - 音符間の位置を線形補間

2. **プレイヘッド**
   - 画面左から100pxの位置に固定表示
   - 楽譜がプレイヘッドの下を通過するようにスクロール

3. **自動スクロール**
   - currentTime（現在の再生時刻）に基づいて計算
   - requestAnimationFrameで60FPSアニメーション

### MusicXMLファイル仕様

#### demo-1.xmlの構造
- 拍子：4/4
- 調号：C Major（臨時記号で各音を表現）
- 音部記号：ト音記号
- 全15小節（最後の小節は1音のみ）

#### MIDI番号と音名の対応例
- MIDI 60 = C4
- MIDI 63 = E♭4
- MIDI 64 = E4
- MIDI 66 = F#4
- MIDI 67 = G4
- MIDI 70 = B♭4
- MIDI 71 = B4
- MIDI 73 = C#5

### 音名情報の抽出と引き継ぎ

#### MusicXMLからの音名抽出
- OpenSheetMusicDisplay（OSMD）から音名情報を抽出
- 臨時記号も含めて正確に取得（#、♭、x、bb）
- タイで結ばれた後続音符は無視（開始音符のみカウント）

#### PIXIノーツへの反映
1. **音名情報の保存**
   - MusicXMLから抽出した音名をgameStoreのnotesに保存
   - 各ノートのnoteNameプロパティに格納

2. **臨時記号の表示**
   - MusicXMLの臨時記号表現をそのまま引き継ぎ
   - ABC記法：C#、Db、F#、Bb など
   - ソルフェージュ記法：ド#、レ♭、ファ#、シ♭ など

3. **表示の正規化**
   - ダブルシャープ（x）→ シャープ（#）
   - ダブルフラット（bb）→ フラット（b）
   - ソルフェージュでは♭記号を使用

### JSONとMusicXMLの整合性チェック

#### チェック項目
1. **音符数の一致**
   - JSONファイルの音符数
   - MusicXMLの音符数（タイの後続音符を除外）

2. **ピッチの順番一致**
   - 各音符のMIDIノート番号が順番通りに一致するか
   - 不一致の場合、何番目の音符が異なるかを表示

#### チェック結果の表示
- 楽譜表示エリアの右上に警告を表示
- 最大3件のエラーを表示（それ以上は省略）
- コンソールに詳細なチェック結果を出力

## 今後の拡張可能性

1. **PIXIエリア**
   - ピンチズームによる拡大縮小
   - スクロールバーの表示
   - スナップスクロール（音符単位）

2. **楽譜表示**
   - 複数の音部記号対応
   - リズム記譜の多様化
   - 楽譜上への演奏結果の表示

3. **整合性チェック**
   - リズム（音価）の検証
   - 調号・臨時記号の整合性チェック
   - 自動修正機能

## 注意事項

- 60FPS維持が最優先事項
- unifiedFrameControllerの使用を厳守
- 複数のアニメーションループの作成は禁止
- スクロール操作とノートドラッグ操作の競合を防ぐ
- MusicXMLのタイ記号を正しく処理（後続音符を無視）