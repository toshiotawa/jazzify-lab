# 認証システム実装計画

**計画作成日時**: 2025年07月08日 11:01:31  
**対象ブランチ**: feature/authentication-system  
**計画者**: Claude AI

## 📋 計画概要

### 目的
音楽ゲームアプリケーションにSupabase Magic Link認証を基盤とした認証システムを実装し、ユーザー管理・管理画面・経験値システムの基礎を構築する。

### 実装方針
- **段階的MVP実装**: Phase 1（認証基盤）から開始し、段階的機能拡張
- **既存システム保持**: 現在のゲーム機能を維持しながら認証システムを統合
- **Supabase統合**: 認証・データベース・ストレージの統合ソリューション採用

## 🎯 技術選択

### 認証・データベース
- **Supabase**: Magic Link認証、PostgreSQL、リアルタイム同期
- **@supabase/supabase-js**: React統合ライブラリ

### フロントエンド拡張
- **React Router v6**: ナビゲーション・保護ルート
- **React Hook Form + Zod**: フォーム管理・バリデーション
- **shadcn/ui**: 管理画面UIコンポーネント

### 状態管理
- **Zustand拡張**: 既存ゲーム状態 + 認証状態統合
- **Immer**: 不変状態管理（既存継続）

## 📊 フェーズ別実装計画

### 🔴 Phase 1: 認証基盤構築 (最高優先度)

#### 1.1 環境・依存関係セットアップ
- **P1-1**: Supabase CLI環境構築・プロジェクト設定
  - Supabase CLI インストール
  - ローカル開発環境初期化
  - データベーススキーマ・マイグレーション作成
  - 認証設定・Magic Link有効化
- **P1-2**: 依存関係インストール
  - @supabase/supabase-js
  - react-router-dom
  - react-hook-form
  - zod
  - supabase (CLI開発依存関係)
- **P1-3**: 環境変数設定（.env.local）

#### 1.2 認証システム実装
- **P1-4**: Supabaseクライアント設定（src/lib/supabase.ts）
- **P1-5**: 認証コンテキスト作成（src/contexts/AuthContext.tsx）
- **P1-6**: 認証状態管理（src/stores/gameStore.ts拡張）
- **P1-7**: Magic Link認証UI実装（src/components/auth/）
- **P1-8**: 認証保護ルート実装（src/components/auth/ProtectedRoute.tsx）

#### 1.3 ルーティング基盤
- **P1-9**: React Router設定（src/router/index.tsx）
- **P1-10**: レイアウトコンポーネント作成（src/layouts/）
- **P1-11**: 認証フロー統合（src/main.tsx, src/App.tsx）

### 🟡 Phase 2: ユーザー管理システム (高優先度)

#### 2.1 データベース設計
- **P2-1**: ユーザープロフィールテーブル設計
- **P2-2**: 会員ランクテーブル設計
- **P2-3**: 初期データ投入

#### 2.2 プロフィール管理
- **P2-4**: プロフィール表示・編集UI
- **P2-5**: アバター・ニックネーム機能
- **P2-6**: プライバシー設定

### 🟢 Phase 3: 基本管理画面 (中優先度)

#### 3.1 管理者認証
- **P3-1**: 管理者ロール設定
- **P3-2**: 管理画面アクセス制御
- **P3-3**: 管理者ダッシュボード作成

#### 3.2 ユーザー管理機能
- **P3-4**: ユーザー一覧・検索
- **P3-5**: 会員ランク変更機能
- **P3-6**: 利用統計表示

## 📝 ファイル変更計画

### 🆕 新規作成ファイル（20ファイル）

#### 設定・認証基盤
- `.env.local` - Supabase環境変数
- `src/lib/supabase.ts` - Supabaseクライアント設定
- `src/contexts/AuthContext.tsx` - 認証コンテキスト
- `src/hooks/useAuth.ts` - 認証フック
- `supabase/config.toml` - Supabase CLI設定
- `supabase/migrations/` - データベースマイグレーション
- `supabase/seed.sql` - 初期データ投入

#### 型定義
- `src/types/auth.ts` - 認証関連型定義
- `src/types/user.ts` - ユーザー関連型定義

#### 認証UI
- `src/components/auth/LoginForm.tsx` - ログインフォーム
- `src/components/auth/AuthLayout.tsx` - 認証レイアウト
- `src/components/auth/ProtectedRoute.tsx` - 保護ルート

#### ルーティング・レイアウト
- `src/router/index.tsx` - React Router設定
- `src/layouts/MainLayout.tsx` - メインレイアウト
- `src/layouts/AuthLayout.tsx` - 認証レイアウト

#### 管理画面
- `src/components/admin/AdminLayout.tsx` - 管理画面レイアウト
- `src/components/admin/Dashboard.tsx` - 管理ダッシュボード
- `src/pages/admin/AdminPage.tsx` - 管理ページ

### 🔄 修正ファイル（8ファイル）

#### 設定・依存関係
- `package.json` - 依存関係追加（supabase CLI含む）
- `vite.config.ts` - 環境変数設定
- `tailwind.config.js` - 管理画面用設定追加
- `.gitignore` - Supabase関連ファイル除外設定

#### アプリケーション統合
- `src/main.tsx` - ルーター・認証プロバイダー統合
- `src/App.tsx` - ルーティング統合
- `src/index.css` - 管理画面用スタイル追加

#### 状態管理・型定義
- `src/stores/gameStore.ts` - 認証状態統合
- `src/types/index.ts` - 型定義追加

## 🧪 テスト戦略

### テストツール選定
- **単体・統合**: Vitest + React Testing Library
- **E2E**: Playwright
- **モック**: MSW (Mock Service Worker)
- **環境**: Docker Compose + Testcontainers

### テスト分類

#### 単体テスト（4ファイル）
- `src/hooks/useAuth.test.ts` - 認証フック機能
- `src/contexts/AuthContext.test.tsx` - 認証コンテキスト
- `src/components/auth/LoginForm.test.tsx` - ログインフォーム
- `src/components/auth/ProtectedRoute.test.tsx` - 保護ルート

#### 統合テスト（3ファイル）
- `src/lib/supabase.integration.test.ts` - Supabase統合
- `src/router/router.integration.test.ts` - ルーティング統合
- `src/stores/gameStore.integration.test.ts` - 状態管理統合

#### E2Eテスト（3ファイル）
- `tests/e2e/auth-flow.e2e.test.ts` - 認証フロー
- `tests/e2e/protected-routes.e2e.test.ts` - 保護ページアクセス
- `tests/e2e/admin-dashboard.e2e.test.ts` - 管理画面

## ⚠️ リスク分析・対策

### 🔴 高リスク

#### 1. 既存ゲーム機能の破綻
- **リスク**: 認証システム統合でゲーム機能が動作しなくなる
- **対策**: 
  - 段階的実装（機能フラグ活用）
  - 既存機能の認証状態独立性確保
  - 徹底的な統合テスト実施

#### 2. Supabase統合の失敗
- **リスク**: 認証API連携・環境設定・Magic Link配信の問題
- **対策**: 
  - 開発環境でのPoC実装
  - Supabase公式ドキュメント準拠
  - 包括的なエラーハンドリング

#### 3. 状態管理の複雑化
- **リスク**: Zustand認証状態とゲーム状態の競合
- **対策**: 
  - 状態の責任分離設計
  - 明確なインターフェース定義
  - Redux DevTools統合

### 🟡 中リスク

#### 4. セキュリティ脆弱性
- **リスク**: 認証トークン漏洩・XSS・不正アクセス
- **対策**: 
  - HTTPSOnly Cookie設定
  - CSP（Content Security Policy）設定
  - 定期的なセキュリティ監査

#### 5. パフォーマンス劣化
- **リスク**: 認証チェック・依存関係によるパフォーマンス低下
- **対策**: 
  - 認証状態キャッシュ機能
  - Code Splitting実装
  - Bundle Size分析・最適化

### 🟢 低リスク

#### 6. UI/UX整合性
- **リスク**: 認証UIと既存ゲームUIの不整合
- **対策**: 
  - shadcn/ui デザインシステム統一
  - ユーザビリティテスト実施

## 📅 実装スケジュール

### Phase 1: 基盤構築（1-2週間）
- Week 1: 環境構築・Supabase統合・認証コンテキスト
- Week 2: 認証UI・ルーティング・保護ルート

### Phase 2: ユーザー管理（1-2週間）
- Week 3: データベース設計・プロフィール管理
- Week 4: 会員ランク・ユーザー設定

### Phase 3: 管理画面（1-2週間）
- Week 5: 管理者認証・ダッシュボード
- Week 6: ユーザー管理機能・統計表示

## ✅ 成功基準

### 技術的成功基準
- [ ] Magic Link認証が正常動作
- [ ] 既存ゲーム機能に影響なし
- [ ] 全テストケースでパス（カバレッジ80%以上）
- [ ] 管理者による基本ユーザー管理が可能

### ユーザー体験成功基準
- [ ] 5秒以内のログイン完了
- [ ] 直感的な認証フロー
- [ ] 既存ゲームプレイに遅延なし
- [ ] 管理画面の使いやすさ

### セキュリティ成功基準
- [ ] 認証トークンの安全な管理
- [ ] 不正アクセス防止機能
- [ ] プライバシー保護機能
- [ ] セキュリティ監査でのクリア

## 🔄 次フェーズ計画

### Phase 4: 経験値・レベルシステム
- 経験値算出ロジック実装
- レベルアップ機能・演出
- ランキング機能基盤

### Phase 5: レッスンシステム
- コース管理システム
- 進捗追跡機能
- 動画・課題管理

### Phase 6: コミュニティ機能
- 練習日記機能
- チャレンジ・ミッション
- SNS連携機能

## 📊 実装完了条件

### 必須条件
1. **認証システム**: Magic Link認証の完全動作
2. **ユーザー管理**: 基本プロフィール・会員ランク管理
3. **管理画面**: 管理者によるユーザー管理機能
4. **テスト**: 全テストケース80%以上カバレッジ
5. **セキュリティ**: 基本的なセキュリティ対策実装

### 推奨条件
1. **パフォーマンス**: ゲーム機能に5%以下の影響
2. **ユーザビリティ**: 認証フロー完了率90%以上
3. **保守性**: コードレビュー基準クリア
4. **拡張性**: 次フェーズ機能追加の容易性

---

## 📋 実装準備チェックリスト

### 事前準備
- [ ] Supabaseアカウント作成
- [ ] プロジェクト環境設定
- [ ] 開発環境でのSupabase接続確認
- [ ] 認証プロバイダー設定

### 実装前確認
- [ ] 現在のゲーム機能テスト実行
- [ ] 既存コードのバックアップ
- [ ] 開発ブランチ作成
- [ ] CI/CD設定確認

### 実装後確認
- [ ] 全テストケース実行
- [ ] セキュリティ監査実施
- [ ] パフォーマンス測定
- [ ] ユーザビリティテスト

---

**計画策定完了**: 2025年07月08日 11:01:31  
**次フェーズ**: IMPLEMENT - 実装フェーズに移行  
**ドキュメント**: `docs/plan/plan_20250708_110131.md`