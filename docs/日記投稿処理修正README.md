# 日記投稿処理修正 - 概要

## 修正された問題

### 1. ミッション進捗ログと実データの不整合
- **問題**: `missionsUpdated++`がエラー判定外で実行され、UI表示とDB更新が不一致
- **修正**: アップサート成功時のみカウントを増加するように変更

### 2. 経験値付与の1日1回制限が機能しない
- **問題**: タイムゾーンのズレにより、日本時間午前0時前後の投稿で重複付与が発生
- **修正**: `xp_history`ベースから`practice_diaries`ベースの判定に変更

## 主な変更点

### `src/platform/supabaseDiary.ts`
- ミッション進捗更新のエラーハンドリング改善
- XP付与判定を`practice_diaries`テーブルベースに変更
- タイムゾーン付きクエリの使用

### `src/platform/supabaseXp.ts`
- `AddXpParams`インターフェースに`reason`パラメータを追加
- XP履歴に理由を記録する機能を追加

## テスト推奨事項

1. **同一日重複投稿テスト**: エラーとなることを確認
2. **タイムゾーン境界テスト**: 00:01 JSTでの投稿テスト
3. **ミッション進捗更新テスト**: 成功/失敗時の動作確認

## 影響範囲

- 日記投稿機能
- ミッション進捗更新
- XP付与システム
- ユーザー体験（UI表示の正確性向上）

## デプロイ前チェックリスト

- [ ] ステージング環境でのテスト完了
- [ ] 既存データとの整合性確認
- [ ] タイムゾーン関連の動作確認
- [ ] エラーログの監視設定 