# リズムモード 基本設計

## アーキテクチャ
```
┌────────────────────────┐
│ FantasyGameEngine      │ 既存: クイズ/プログレッション
│   ├─ QuizModeLogic     │   |
│   ├─ RhythmModeLogic   │★ 新規
│   └─ UI Components     │
└────────────────────────┘
        ▲        ▲
        │        │ zustand timeStore 強化
        │        └───────────────┐
        │                        │
┌─────────────┐         ┌─────────────────┐
│ BGMManager  │──再生→ │  useTimeStore   │
└─────────────┘         └─────────────────┘
```

- RhythmModeLogic: 判定ウィンドウ、曲進行データ、敵管理を担当。
- useTimeStore: `currentMeasure`, `currentBeat`, `isCountIn` を持ち、1/16 拍精度で更新。

## データフロー
1. BGM 再生開始時に BPM, 拍子, count-in を useTimeStore へ設定。
2. `requestAnimationFrame` でタイムスタンプを取得し、measure/beat を計算。
3. RhythmModeLogic は `scheduledQuestions` の時刻を監視、判定ウィンドウに入ったら受付開始。
4. 入力されたノートは `checkChordMatch()` を再利用して判定。
5. 成功で `onChordCorrect`, 失敗で `onEnemyAttack` を dispatch。

## ストア設計 (timeStore)
```
interface TimeState {
  isCountIn: boolean;
  currentMeasure: number; // 1〜
  currentBeat: number;    // 1〜timeSignature
  absoluteTime: number;   // ms from BGM start (countIn含まず)
}
```
API:
- `start(bpm, timeSignature, countInMeasures)`
- `reset()`

## RhythmQuestion 型
```
{
  id: string;
  measure: number;
  beat: number; // 小数可
  chord: string;
  monsterPosition: 'A'|'B'|'C'|'D';
  windowStart: number; // ms
  windowEnd: number;   // ms
}
```

## 判定ロジック
```
if (windowStart <= now <= windowEnd) {
   success
} else if (now > windowEnd) {
   failure
}
```

## BGM ループ処理
BGMManager の `onLoop` コールバックで `useTimeStore.skipCountIn()` を呼び、measure を 1 にリセット。

