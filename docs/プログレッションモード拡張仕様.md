# プログレッションモード拡張仕様

## 概要

ファンタジーモードのプログレッションパターンを拡張し、より精密なタイミング制御を実装しました。
主な拡張点は以下の通りです：

1. **出題タイミングの制御**
2. **判定受付終了タイミングの設定**
3. **NULL時間の実装**
4. **失敗時の自動進行**
5. **chord_progression_dataによる細かいタイミング指定**

## タイミング仕様

### 1. 出題タイミング

- **4拍子の場合**: 4拍目のウラ（beats: 4.5）で問題が出現
- **3拍子の場合**: 3拍目のウラ（beats: 3.5）で問題が出現
- **一般化**: `timeSignature + 0.5` で出題

### 2. 判定受付タイミング

- **受付開始**: 前の問題の出題直後から
- **受付終了**: 次の出題タイミングの0.01拍前
  - 4拍子の場合: 4.49まで
  - 3拍子の場合: 3.49まで

### 3. NULL時間

判定受付終了から次の出題までの間は「NULL時間」となり、以下の状態になります：

- 現在のコードが`null`として扱われる
- プレイヤーの入力は無効化される
- 画面上の表示もNULL状態を反映

### 4. 失敗時の自動進行

判定受付終了時点で構成音が完成していない場合：

1. 自動的にNULL時間へ移行
2. 次の出題タイミングで新しい問題を表示
3. プレイヤーは連続してプレイを継続可能

## chord_progression_data の仕様

### データ構造

```typescript
interface ChordProgressionTiming {
  bar: number;    // 小節番号（1から始まる）
  beats: number;  // 拍位置（1-4、小数点可能）
  chord: string;  // コード名
}
```

### 使用例

```json
{
  "chord_progression_data": [
    { "bar": 1, "beats": 3, "chord": "C" },
    { "bar": 2, "beats": 1, "chord": "F" },
    { "bar": 2, "beats": 3, "chord": "G" },
    { "bar": 3, "beats": 1, "chord": "C" }
  ]
}
```

### タイミング計算

1. **コードの有効期間**: 各コードは指定された`bar`と`beats`から始まり、次のコードの0.49拍前まで有効
2. **NULL時間**: 次のコードの0.49拍前から次のコードの開始まで
3. **判定受付**: コードの開始から次のコードの0.49拍前まで

### 例: 上記データでのタイミング

```
小節1:
  拍1-2.49: NULL
  拍2.5-2.99: NULL
  拍3-4: C (判定受付中)

小節2:
  拍1-2.49: F (判定受付中)
  拍2.5-2.99: F (判定受付終了→NULL)
  拍3-4: G (判定受付中)

小節3:
  拍1-...: C (判定受付中)
```

## 実装詳細

### 主要な関数

1. **`isProgressionInputTiming(currentBeat, timeSignature)`**
   - 現在の拍が判定受付中かどうかを判定

2. **`isProgressionQuestionTiming(currentBeat, timeSignature, tolerance)`**
   - 現在の拍が出題タイミングかどうかを判定

3. **`getCurrentProgressionChord(progressionData, currentMeasure, currentBeat, acceptanceEnd)`**
   - chord_progression_dataから現在有効なコードを取得
   - NULL時間の場合は`null`を返す

### ゲーム状態の管理

```typescript
interface FantasyGameState {
  // ... 既存のフィールド
  isNullPhase: boolean;        // NULL時間中かどうか
  isQuestionPresented: boolean; // 問題が提示されているか
}
```

## 従来モードとの互換性

- **シングルモード**: 影響なし（従来通りの動作）
- **配列ベースのプログレッション**: 従来通り4拍子で1小節1コードの動作を維持
- **chord_progression_data使用時**: 新しいタイミング制御が適用される

## テスト

以下のケースについてユニットテストを実装：

1. chord_progression_dataによるタイミング制御
2. 従来の配列ベースプログレッション
3. 3拍子での動作
4. NULL時間中の入力無効化
5. 判定受付タイミング外での入力無効化

## 今後の拡張性

1. **判定受付終了タイミングの動的設定**: 現在は0.49拍前で固定だが、パラメータ化可能
2. **NULL時間のビジュアル表現**: 画面効果やアニメーションの追加
3. **複雑な拍子への対応**: 5拍子、7拍子などへの対応