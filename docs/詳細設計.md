# リズムモード 詳細設計

## useTimeStore 拡張
```
export interface TimeState {
  isCountIn: boolean;
  currentMeasure: number;
  currentBeat: number;
  bpm: number;
  timeSignature: number;
  countInMeasures: number;
  startAt: number; // AudioContext.currentTime(ms)
}
```
- `tick(audioTimeMs)` : RAF / AudioWorklet から呼び出し、state を更新。

## RhythmGameEngine 実装
ファイル: `src/utils/rhythmGameEngine.ts` (既存を活用)

### 主要プロパティ
- `questions: RhythmQuestion[]` スケジュール済み問題
- `activeQuestions: Set<string>` 判定ウィンドウ中の問題ID
- `bpm, ts, countIn` : stage から取得

### メソッド
1. `loadStage(stage)`
   - ランダム or プログレッションで `questions` 配列を生成。
2. `start()`
   - BGMManager.play()
   - useTimeStore.start()
3. `onTick(t)`
   - timeStore から measure/beat を取得
   - `questions` を走査しウィンドウ突入時に active へ追加
   - ウィンドウ終了したら失敗処理
4. `onMidiInput(notes)`
   - activeQuestions をコード判定し、成功で monster.damage()

### 質問生成アルゴリズム
- ランダム: 1〜measureCount まで 1小節毎に allowedChords から乱択。
- プログレッション: `chord_progression_data` を読み込み、そのまま配列化。

## UI コンポーネント
- `RhythmStageHUD`
  - カウントイン表示: `M / - B x`
  - メイン表示: `M n - B b`
  - 攻撃ゲージ: `RhythmGauge` (0〜100%)

## モンスター配置
- ランダム: 1体 => 列 `D`
- プログレッション(4拍子): A,B,C,D 列。3拍子の場合 A,B,C。

---
## テスト計画
1. `rhythmGameEngine` ユニットテスト
   - ウィンドウ時間 ±200ms 判定。
   - 成功・失敗遷移。
2. `timeStore` テスト
   - count-in 済み measure/beat 計算。
3. E2E (vitest + jsdom)
   - BGM 再生シミュレーションで question スケジューリング確認。
