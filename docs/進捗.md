#希望
新機能について、どこまで実装が住んでいるか調査してください。ultrathinking必須。

##要望
**パフォーマンス**：Supabase 呼び出しのレイテンシ → キャッシュ & WebSocket サブスク活用  
Postgres + RLS + Realtimeで低レイテンシを狙う。

##残タスク
― UI/UXポリッシュ・細かな調整
― プラチナプラン高度機能 (課題提出・LINE連携)
― 

## レッスン機能要件の進捗

### 2025-01-17: レッスン機能実装状況

| 要件 | 状態 | 説明 |
|------|------|------|
| 1. GameHeader表示 | ✅ 完了 | LessonDetailPageにGameHeaderを組み込み済み |
| 2. ワンカラムレイアウト | ✅ 完了 | 2カラムからワンカラムレイアウトに変更済み |
| 3. 実習課題完了チェック | ✅ 完了 | 実習課題の完了状態をチェックして完了ボタンを制御 |
| 4. プラチナプラン完了ボタン非表示 | ✅ 完了 | プラチナプランの場合は完了ボタンを非表示、スキップボタンのみ表示 |
| 5. 5レッスンずつ解放 | ✅ 完了 | 5レッスンごとのグループ単位で解放する機能を実装 |
| 6. 日数条件追加 | ✅ 完了 | 実習課題に日付をまたいだ累計クリア日数の追跡機能を実装 |
| 7. 実習課題進捗紐づけ | ✅ 完了 | user_lesson_requirements_progressテーブルで進捗を追跡 |
| 8. 完了マーク | ✅ 完了 | 実習課題の完了・未完了マークと進捗バーを表示 |
| 9. レッスン進捗管理 | ✅ 完了 | レッスンの進捗を管理する機能を実装 |
| 10. レッスン解放管理 | ✅ 完了 | レッスンの解放状態を管理する機能を実装 |
| 11. ユーザー進捗管理UI整理 | ✅ 完了 | UserManager.tsxでブロック・レッスンの進捗管理UIを整理 |

### 2025-01-20: ユーザー進捗管理UI整理

#### 実装内容
- **UserManager.tsx**の進捗管理UIを大幅に整理
- ブロックとレッスンの管理を明確に分離：
  - ブロック：解放/未解放の状態管理のみ
  - レッスン：解放/未解放 + 完了/未完了の状態管理
- 視覚的改善：
  - 進捗概要ダッシュボードを追加（総ブロック数、総レッスン数、解放済み、完了済み）
  - アイコンと色分けによる状態の視覚化
  - ブロックヘッダーと進捗表示
- 操作の整理：
  - ブロック解放ボタンとレッスン解放ボタンを分離
  - 完了/未完了の切り替えを明確化
  - UIの階層化（ブロック > レッスン）

### 実装済みの変更内容

#### 1. データベース変更
- `supabase/migrations/20250717120000_add_lesson_requirements_progress.sql`:
  - `user_lesson_requirements_progress`テーブルを作成
  - 実習課題の進捗（クリア回数、クリア日数、完了状態）を追跡
  - `update_lesson_requirement_progress`関数で自動的に進捗を更新

#### 2. 新規ファイル
- `src/platform/supabaseLessonRequirements.ts`:
  - 実習課題の進捗管理機能
  - 進捗の取得、更新、完了チェック機能

#### 3. 更新ファイル
- `src/components/lesson/LessonDetailPage.tsx`:
  - GameHeaderコンポーネントを使用
  - ワンカラムレイアウトに変更
  - 実習課題の進捗表示（進捗バー、完了マーク、最高ランク）
  - 実習課題が完了していない場合は完了ボタンが押せない
  - プラチナプランは完了ボタンなし、スキップボタンのみ

- `src/components/lesson/LessonPage.tsx`:
  - 5レッスンずつの解放ロジックを実装
  - 前の5レッスンがすべて完了したら次の5レッスンが解放

- `src/platform/supabaseLessonContent.ts`:
  - `clear_conditions`に`requires_days`プロパティを追加

- `src/types/index.ts`:
  - `ClearConditions`インターフェースに`requires_days`プロパティを追加（2025-01-17追加）
  - `daily_count`プロパティを追加（2025-01-17追加: 1日あたりの必要クリア回数）

- `src/components/admin/LessonManager.tsx`（2025-01-17更新）:
  - 曲追加ダイアログに達成条件のチェックボックスを追加
  - 日数でカウントする場合、1日あたりの必要クリア回数フィールドを表示
  - 実習課題一覧で「N回×N日間」形式の表示に対応

- `src/components/lesson/LessonDetailPage.tsx`（2025-01-17更新）:
  - 日数条件の場合、各日の進捗を個別に表示
  - 1日目、2日目...5日目のような進捗バーを表示
  - 今日の進捗がリアルタイムで更新される
  - 必要回数に達した日は完了マーク（✓）を表示

- `src/platform/supabaseLessonRequirements.ts`（2025-01-17更新）:
  - `LessonRequirementProgress`インターフェースに`daily_progress`フィールドを追加

- `src/platform/supabaseLessonProgress.ts`（2025-01-17更新）:
  - `updateLessonProgress`関数に`targetUserId`パラメータを追加（管理者用）
  - `unlockLesson`関数に`targetUserId`パラメータを追加（管理者用）

- `src/components/admin/UserManager.tsx`（2025-01-17更新）:
  - レッスン進捗管理モーダルを追加
  - ユーザーごとのレッスン解放・完了を管理できる機能を実装
  - コース別にレッスン進捗を表示・編集可能

- `src/components/admin/LessonManager.tsx`（2025-01-17更新）:
  - 曲削除時のデバッグログを追加
  - 削除前後の曲リストをコンソールに出力

#### 4. データベース更新（2025-01-17）
- `supabase/migrations/20250717125000_add_daily_progress_tracking.sql`:
  - `user_lesson_requirements_progress`テーブルに`daily_progress` jsonbカラムを追加
  - `update_lesson_requirement_progress`関数を更新して日ごとの進捗を追跡
  - 1日あたりの必要回数を達成した場合のみその日を完了とする

### 実装の特徴
- 日数条件の実習課題は日付をまたいだクリアをカウント
- 同じ日に何回クリアしても1日分としてカウント
- 実習課題ごとに進捗バーと完了マークを表示
- プラチナプランユーザーは全レッスン解放済み
- 管理画面から日数条件か回数条件かを設定可能
- **回数×日数の複合条件に対応**（2025-01-17追加）:
  - 例：「5回×5日間」の場合、毎日5回クリアを5日間続ける必要がある
  - 各日の進捗が個別に追跡され、その日の必要回数に達しない場合は完了にならない
  - 今日の進捗がリアルタイムで表示される

##構想
--------
・supabaseのmagic linkでログインさせたい。
supabase
初期画面を追加、

・ログインせずおためしボタン
・会員登録(メールアドレスを入力)

・ログイン(メールアドレスを入力)

・ログイン後
ログイン後、アカウントが存在しない場合、アカウントの登録
利用規約、プライバシーポリシーへの同意チェック後、アカウント登録
ニックネーム(日記やランキングに表示される)を登録。
そこがトップページになる

お試しプレイでも全てのタブは表示される。コミュニティタブの日記は中身はログインしないと見えないように。



・ヘッダー右端に会員登録/ログイン時はアカウントボタンを。ヘッダー左端にはトップページボタンを。ヘッダーは既存のものを流用する。

アカウントはモーダルで。
会員ランクを確認できる

会員ランクは
フリー、スタンダード、プレミアム、プラチナ。
ランクによって表示される要素に変化はないが、アクセスできる、曲、レッスン、ミッション/チャレンジに制限がある。


・管理画面を作りたい。
shadcn/ui や React-Hook-Formと組み合わせて曲登録ダッシュボードを追加したい（曲の管理方法をjsonハードコーディングから変更)
管理画面では会員のステータスを変更したい。


・ヘッダー右端のアカウントボタンの左にマイページボタンを設置

曲の記録が表示される。曲が一覧で表示される。
最高ランク、Bランク以上でのクリア回数を表示
レッスンの進捗状況も確認できる。

・無料会員では遊べる曲を制御(管理画面で制御)


・経験値システム
本番モード(ステージ)を終了すると経験値が得られる
会員ランクに応じて得られる経験値の倍率が違う。（プレミアム1.5x プラチナ2x)

再生速度によって得られる経験値が違う(1xがマックス、再生速度を落とすとその分だけ得点倍率が下がる)

スコアランクに応じて経験値が違う(Sランクで1000点とかかな。最低でも100点は入る)

移調してプレイすると1.3倍ボーナス

経験値テーブルはレベル1-10までは2000点で1レベル上がるくらい。
11-50は5000点で1レベル上がる。
51以降は20000点で1レベル上がる。

全期間のレベルランキングを作成する、
ニックネーム、レベル、会員ランク、クリアレッスン数が表示される。
(同レベルの場合は経験値順)


結果画面に獲得経験値と、ボーナスを表示(ボーナスは後述するがレッスンボーナス、ミッションボーナス、チャレンジボーナスもある)
レベルも表示(45 → 46 Level UP!)のような。
上がらなくても表示


・レッスン
プレミアム、プラチナプランはレッスンをプレイすることができる。(フリー、スタンダードでも数曲プレイ可能、管理画面でプレイ可能レッスンは制御できる。)
マイページ左端にレッスンボタンを用意。

レッスン→コース↛動画&曲という序列になっている。
動画数の制限はない(0でもOK)曲も制限はない(0でもOK)
しかしどちらかは1つは存在しないといけない。

コース一覧にコースの進捗バーを表示。
レッスン一覧では解放されていないレッスンには鍵マーク。
クリアしたレッスンにはクリア日とクリアマーク。

動画はvimeoで埋め込み。

曲は管理画面で追加する。
その曲のクリア条件を管理画面で指定する(キー、再生速度、スコアランク、クリア回数、(楽譜表示設定「ノート+コードorコードのみ」)。レッスンクリア条件テキストとして自動で埋め込む。)

例キー+-0で、再生速度1.0以上で、スコアランクB以上、楽譜表示設定「コードのみ」で10回クリア

すべての曲のクリア条件を達成することで、プレミアムプランでは先のレッスンに進める。

プラチナプランではLINE上で講師とやり取りして提出するような課題があり、その課題説明宿題も管理画面で書く
提出課題のチェックボタンは生徒が押すことができる。
課題提出5日間、のような課題の場合1.2.3.4.5日目のチェックボックスを生徒が埋めていく。


プラチナプランではスキップボタンを押し、レッスンをスキップすることができる。(確認モーダルを出す)
プラチナプランのレッスンの解放状態、完了状態の管理は管理画面から管理者が行うこともできる。
マイページモーダルで進捗を確認することもできる
(例コースドロップダウン→
レッスン1 完了✓・解放✓
レッスン2 完了　・解放✓
レッスン3 完了　・解放✓
レッスン4 完了　・解放
レッスン5 完了　・解放
のように)


プレミアムプランではスキップボタンを押せないように。
レッスンの曲を本番モードでプレイする場合、通常より経験値2倍入る。



・ウィークリーチャレンジ、マンスリーミッションを管理画面で追加できるように
ウィークリーチャレンジ、マンスリーミッション

それぞれ自由に曲、クリア条件(キー、再生速度、スコアランク、クリア回数、(楽譜表示設定「ノート+コードorコードのみ」)を指定し、
レッスンクリア条件テキストとして自動で埋め込む。

マイページにチャレンジ、ミッションは表示されていて、進捗バー(クリア回数 5/10回のように)、が表示される。

チャレンジ、ミッションの達成報酬はそれぞれ翌シーズン経験値1.3倍獲得。

そのシーズンと一つ前シーズンのランキングを表示させる、先着100名まで、フォーマットはレベルランキングと同様のものを使用。
曲は既存の曲の中から選択させるようにし、



・ユーザーのトップページダッシュボード？
ダッシュボードには、お知らせ、チャレンジとミッションが表示される。
お知らせは管理画面で編集できる(リンク付きテキストも可能)


・曲選択の曲一覧をシンプル(今はスペースが大きいかも)
アーティストアルファベット順→曲名アルファベット順。

・結果画面に次にプレイするべきおススメ曲を表示(通常プレイ時、レッスンではない)
ミッション・チャレンジ達成していないならその曲。



・練習日記
ヘッダーにコミュニティタブを用意

そこではその日のユーザーの練習日記が表示される。

練習日記(1日1記事)作成することができる。
編集はとコメントは可能。
他のユーザーはいいねを押すことができる。

ユーザー名をクリックすると、そのユーザーの練習日記ページに飛ぶことができる。

日記で経験値が入るように。



### メモ
- 60FPS維持は最低条件**: `unifiedFrameController` 使用必須、競合ループ禁止!!!!
- Supabase 管理画面 → Schedules → New schedule で `reset-season-multiplier` を定期実行設定

## 2025-01-12: 曲管理システムのデータベース移行

### 実装内容
1. **データベーススキーマの更新**
   - `songs`テーブルに`audio_url`、`xml_url`、`json_url`フィールドを追加
   - `data`フィールドを`json_data`に名前変更（わかりやすくするため）
   - マイグレーションファイル: `supabase/migrations/20250112000000_add_song_file_urls.sql`

2. **Supabaseストレージ統合**
   - `song-files`バケットで曲ファイル（MP3、XML、JSON）を管理
   - ファイルアップロード・削除機能を実装
   - 最大ファイルサイズ: 50MB

3. **管理画面の改善**
   - ファイルアップロードUI追加（ドラッグ&ドロップ対応）
   - アップロード進捗表示
   - ファイルタイプごとのバッジ表示

4. **ゲーム画面の更新**
   - 新しいスキーマに対応
   - ハードコードされた曲（Demo-1）を削除
   - JSONデータはURLまたはインラインの両方に対応

### セットアップ手順
```bash
# 1. マイグレーションを実行
npx supabase db push

# 2. ストレージバケットを作成（サービスロールキーが必要）
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key node scripts/init-storage-buckets.js

# 3. Demo-1楽曲をアップロード
# 管理画面から以下のファイルをアップロード：
# - public/demo-1.json
# - public/demo-1.mp3
# - public/demo-1.xml
```

### 使用方法
1. 管理画面（`/admin`）の「曲管理」セクションにアクセス
2. 必要情報を入力：
   - タイトル（必須）
   - アーティスト（任意）
   - 最低ランク
3. ファイルをアップロード：
   - JSONファイル（必須）：ノーツデータ
   - MP3ファイル（任意）：音源
   - XMLファイル（任意）：楽譜（MusicXML）
4. 「追加」ボタンをクリック

### 技術的詳細
- ファイルは`song-files/{songId}/{fileType}.{ext}`形式で保存
- 公開URLが自動生成され、データベースに保存
- 曲削除時は関連ファイルも自動削除

## 2025-01-12: BPMと難易度フィールドの削除

### 実装内容
1. **データベース制約の修正**
   - `songs`テーブルの`bpm`と`difficulty`フィールドのNOT NULL制約を削除
   - マイグレーションファイル: `supabase/migrations/20250712120806_remove_bpm_difficulty_constraints.sql`

2. **UI更新**
   - 管理画面の曲一覧から難易度表示を削除
   - これらのフィールドは使用しない方針に変更

### 理由
- BPMと難易度の機能は不要との判断
- シンプルな実装を維持するため

## 2025-01-12: asset_urlカラムの削除

### 実装内容
1. **不要なカラムの削除**
   - `songs`テーブルの`asset_url`カラムを削除（古いスキーマの残骸）
   - マイグレーションファイル: `supabase/migrations/20250712121330_remove_asset_url_column.sql`

2. **現在の正しいカラム構成**
   - `audio_url`: MP3ファイルのURL
   - `xml_url`: MusicXMLファイルのURL
   - `json_url`: JSONファイルのURL
   - `json_data`: インラインJSONデータ（json_urlが優先）

### 背景
- 古いマイグレーションまたは手動変更で追加された`asset_url`カラムが残っていた
- 現在のコードベースでは使用されていないため削除

## 2025-01-12: RLSポリシーの追加

### 実装内容
1. **songsテーブルのRLSポリシー追加**
   - 全ユーザーが読み取り可能
   - 管理者（is_admin = true）のみ追加・更新・削除可能
   - マイグレーションファイル: `supabase/migrations/20250712122653_add_songs_rls_policies.sql`

2. **管理者権限の確認**
   - profilesテーブルの`is_admin`フィールドがtrueである必要があります
   - Supabase SQL Editorで以下を実行して確認：
     ```sql
     SELECT id, email, is_admin FROM public.profiles WHERE email = 'your-email@example.com';
     ```

3. **管理者権限の付与（必要な場合）**
   ```sql
   UPDATE public.profiles SET is_admin = true WHERE email = 'your-email@example.com';
   ```

### 背景
- RLSが有効だがポリシーが未定義だったため、すべての操作がブロックされていた
- 適切なセキュリティを保ちながら管理者が曲を管理できるようにした

### 2025-01-21: レッスン機能追加修正

#### 実装内容
1. **実習課題チェック修正**: レッスン完了ボタンで全ユーザーに対して実習課題の完了チェックを実施
   - LessonDetailPage.tsxのhandleComplete関数を修正
   
2. **移調ボタン制御**: レッスンモード時に移調ボタンを非表示に
   - ControlBar.tsxでlessonContextがある場合は移調ボタンを非表示
   - 練習モード切り替え時に楽譜表示を「ノート+コード」に設定
   
3. **曲変更時の設定リセット**: 曲を変更した際に設定を初期値に戻す
   - gameStore.tsのloadSong関数で、レッスンモード以外ではtransposeを0、playbackSpeedを1.0にリセット