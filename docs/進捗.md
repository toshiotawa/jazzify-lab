#希望
新機能について、どこまで実装が住んでいるか調査してください。ultrathinking必須。

##要望
**パフォーマンス**：Supabase 呼び出しのレイテンシ → キャッシュ & WebSocket サブスク活用  
Postgres + RLS + Realtimeで低レイテンシを狙う。

##残タスク
― UI/UXポリッシュ・細かな調整
― プラチナプラン高度機能 (課題提出・LINE連携)
― 

## レッスン機能要件の進捗

### 2025-01-25: ミッション機能強化

#### 実装内容
- **ミッションからの曲プレイ機能**:
  - ミッションページから曲を直接プレイ可能
  - 曲のクリア回数を進捗バーで表示
  - 全ての曲の進捗が100%になったらクリアボタンが押せる
  - ミッションコンテキストでの進捗管理
- **曲進捗管理システム**:
  - `MissionSongProgress`コンポーネントで各曲の進捗を表示
  - クリア回数と必要回数の進捗バー
  - 完了した曲の視覚的フィードバック
  - プレイボタンで直接ゲーム画面に遷移
- **ミッション完了判定ロジック**:
  - 全ての曲の進捗が100%でミッション完了
  - 完了時にクリアボタンが有効化
  - ゲーム結果からミッション進捗を自動更新
- **データベース連携**:
  - `user_song_progress`テーブルで曲のクリア回数を追跡
  - ミッション完了時の自動更新機能
  - キャッシュ機能によるパフォーマンス最適化

#### 実装ファイル
- `src/platform/supabaseMissions.ts` - ミッション進捗管理API追加
- `src/stores/missionStore.ts` - 曲進捗管理機能追加
- `src/components/mission/MissionSongProgress.tsx` - 曲進捗表示コンポーネント新規作成
- `src/components/mission/ChallengeCard.tsx` - 曲進捗表示機能追加
- `src/components/game/GameScreen.tsx` - ミッション曲プレイ機能追加
- `src/stores/gameStore.ts` - ミッションコンテキスト管理追加
- `src/components/game/ResultModal.tsx` - ミッション進捗更新機能追加
- `src/types/index.ts` - ミッションコンテキスト型定義追加

### 2025-01-25: Tone.jsエラー修正

#### 実装内容
- **Tone.js動的読み込みの修正**:
  - main.tsxでTone.jsの読み込みがコメントアウトされていた問題を修正
  - MidiController.tsでTone.jsが利用できない場合の動的読み込み機能を追加
  - 型定義ファイルでTone.jsの詳細な型定義を追加
- **エラーハンドリングの改善**:
  - Tone.js読み込み失敗時の適切なエラーメッセージ
  - 音声システム初期化の遅延ロード対応
- **実装ファイル**:
  - `src/main.tsx` - Tone.js動的読み込み修正
  - `src/utils/MidiController.ts` - 動的読み込み機能追加
  - `src/types/global.d.ts` - Tone.js型定義詳細化

### 2025-01-25: 管理画面ミッション管理機能強化

#### 実装内容
- **ミッション追加時の楽曲選択機能**:
  - 曲クリアタイプのミッション作成時に楽曲を同時に追加可能
  - 既存のレッスン曲・通常曲から選択可能
  - 楽曲名とアーティスト名を表示
  - 楽曲検索機能とタイプ別フィルター
  - 選択済み楽曲の表示と削除機能
- **楽曲条件のデフォルト設定**:
  - キー調整: 0
  - 最低速度: 1.0x
  - 最低ランク: B
  - 最低クリア回数: 1回
  - 楽譜表示設定: 両方
- **実装ファイル**:
  - `src/components/admin/MissionManager.tsx` - ミッション管理画面強化
  - `src/components/admin/SongSelector.tsx` - 楽曲選択コンポーネント

### 2025-01-17: レッスンナビゲーション機能

#### 実装内容
- **レッスン詳細ページにナビゲーションボタンを追加**
  - 手前のレッスンに戻る
  - コースに戻る
  - 次のレッスンに進む
  
- **ブロック表記の改善**
  - 従来: "ブロック 1 (レッスン 1-5)"
  - 改善後: "ブロック 1"
  
- **エラーハンドリング実装**
  - コースの最初/最後でのナビゲーション制限
  - レッスン解放状態のチェック
  - ユーザーフレンドリーなエラーメッセージ
  - ブロック境界での適切な警告表示

- **パフォーマンス最適化 (2025-01-24)**
  - ナビゲーション情報のメモリキャッシュ（TTL: 5分）
  - キャッシュサイズ制限とクリーンアップ機能
  - ナビゲーション時の不要キャッシュ削除
  - デバウンシング機能でUI応答性向上
  - 処理中状態表示でユーザビリティ改善

- **実装ファイル**
  - `src/utils/lessonNavigation.ts` - ナビゲーション用ユーティリティ
  - `src/components/lesson/LessonDetailPage.tsx` - UI統合
  - `src/components/lesson/LessonPage.tsx` - ブロック表記修正

### 2025-01-17: 既存機能（継続中）
- レッスン動画視聴
- 実習課題システム
- 進捗管理とブロック解放
- スキップ機能（プラチナプラン）
- リアルタイム演奏判定

## 技術仕様

### ナビゲーション機能
```typescript
interface LessonNavigationInfo {
  previousLesson: Lesson | null;
  nextLesson: Lesson | null;
  canGoPrevious: boolean;
  canGoNext: boolean;
  course: {
    id: string;
    hasAccessToPrevious: boolean;
    hasAccessToNext: boolean;
  };
}
```

### エラーハンドリング
- レッスン解放状態の動的チェック
- ブロック境界での警告メッセージ
- ナビゲーション前のバリデーション
- ユーザー体験を重視したメッセージング

## 今後の拡張予定
- [ ] キーボードショートカット（矢印キー等）
- [ ] レッスン内でのセクションジャンプ
- [ ] 進捗可視化の改善
- [ ] オフライン対応

## 最新の実装状況 (2025-01-25)
### ✅ ミッション機能強化
- **ミッションからの曲プレイ機能**: ミッションページから曲を直接プレイ可能
- **曲進捗管理システム**: 各曲のクリア回数を進捗バーで表示、完了判定
- **ミッション完了判定ロジック**: 全ての曲の進捗が100%でミッション完了
- **データベース連携**: 曲のクリア回数追跡とミッション進捗自動更新
- **実装ファイル**: supabaseMissions.ts、missionStore.ts、MissionSongProgress.tsx、ChallengeCard.tsx、GameScreen.tsx、gameStore.ts、ResultModal.tsx、types/index.ts

### ✅ 管理画面ミッション管理機能強化
- **ミッション追加時の楽曲選択機能**: 曲クリアタイプのミッション作成時に楽曲を同時に追加可能
- **楽曲選択UI**: 楽曲検索機能、タイプ別フィルター、選択済み楽曲の表示と削除機能
- **楽曲条件のデフォルト設定**: キー調整、最低速度、最低ランク、最低クリア回数、楽譜表示設定
- **実装ファイル**: MissionManager.tsx、SongSelector.tsx

### ✅ ヘッダーナビゲーション改善
- **ミッションランキングの削除**: GameHeader.tsxからミッションランキングリンクを削除
- **songsページにミッション追加**: GameScreen.tsxのヘッダーにミッションリンクを追加
- **MissionRanking実装強化**: 
  - エラーハンドリングとローディング状態の改善
  - ランキング表示のUI改善（トロフィーアイコン、メダル表示）
  - レスポンシブデザインの適用
  - ユーザビリティの向上
- **MissionPage実装強化**:
  - エラーハンドリングとローディング状態の改善
  - ミッション概要セクションの追加
  - 統一されたUIデザインの適用
  - アクセシビリティの改善

### ✅ 管理画面チャレンジ機能強化 (2025-01-25)
- **チャレンジタイプの明確化**:
  - 日記投稿タイプと曲クリアタイプを明確に区別
  - チャレンジカテゴリ選択機能（日記投稿/曲クリア）
  - カテゴリに応じた動的フォーム（必要投稿数/必要クリア数）
- **ChallengeManagerの大幅改善**:
  - チャレンジ選択と楽曲管理の2画面レイアウト
  - 楽曲条件編集モーダル
  - リアルタイム更新機能
  - エラーハンドリングの強化
  - 楽曲追加ボタンの改善と視覚的強化
  - 日記投稿チャレンジの専用表示エリア
  - アイコンとバッジによる視覚的改善
- **supabaseChallenges.tsの拡張**:
  - `ChallengeCategory`型の追加（'diary' | 'song_clear'）
  - `song_clear_count`フィールドの追加
  - 楽曲管理用API関数の追加
  - ChallengeSongインターフェースの定義
  - 楽曲条件のCRUD操作
- **データベーススキーマ更新**:
  - `challenges`テーブルに`category`カラムを追加
  - `song_clear_count`カラムを追加
  - 既存データの移行対応

### 実装ファイル
- `src/components/ui/GameHeader.tsx` - ヘッダーナビゲーション修正
- `src/components/game/GameScreen.tsx` - songsページヘッダー修正
- `src/components/ranking/MissionRanking.tsx` - ランキング表示改善
- `src/components/mission/MissionPage.tsx` - ミッションページ改善
- `src/LegacyApp.tsx` - インポート追加
- `src/platform/supabaseChallenges.ts` - 楽曲管理API追加
- `src/components/admin/SongSelector.tsx` - 楽曲選択コンポーネント新規作成
- `src/components/admin/ChallengeManager.tsx` - 管理画面大幅改善
- `src/components/admin/MissionManager.tsx` - ミッション管理画面強化

## 注意事項
- ナビゲーション機能は user_lesson_progress テーブルの is_unlocked フィールドに依存
- ブロック解放ロジックは既存のシステムを維持
- エラーメッセージは日本語ユーザー向けに最適化

##構想
--------
・supabaseのmagic linkでログインさせたい。
supabase
初期画面を追加、

・ログインせずおためしボタン
・会員登録(メールアドレスを入力)

・ログイン(メールアドレスを入力)

・ログイン後
ログイン後、アカウントが存在しない場合、アカウントの登録
利用規約、プライバシーポリシーへの同意チェック後、アカウント登録
ニックネーム(日記やランキングに表示される)を登録。
そこがトップページになる

お試しプレイでも全てのタブは表示される。コミュニティタブの日記は中身はログインしないと見えないように。



・ヘッダー右端に会員登録/ログイン時はアカウントボタンを。ヘッダー左端にはトップページボタンを。ヘッダーは既存のものを流用する。

アカウントはモーダルで。
会員ランクを確認できる

会員ランクは
フリー、スタンダード、プレミアム、プラチナ。
ランクによって表示される要素に変化はないが、アクセスできる、曲、レッスン、ミッション/チャレンジに制限がある。


・管理画面を作りたい。
shadcn/ui や React-Hook-Formと組み合わせて曲登録ダッシュボードを追加したい（曲の管理方法をjsonハードコーディングから変更)
管理画面では会員のステータスを変更したい。


・ヘッダー右端のアカウントボタンの左にマイページボタンを設置

曲の記録が表示される。曲が一覧で表示される。
最高ランク、Bランク以上でのクリア回数を表示
レッスンの進捗状況も確認できる。

・無料会員では遊べる曲を制御(管理画面で制御)


・経験値システム
本番モード(ステージ)を終了すると経験値が得られる
会員ランクに応じて得られる経験値の倍率が違う。（プレミアム1.5x プラチナ2x)

再生速度によって得られる経験値が違う(1xがマックス、再生速度を落とすとその分だけ得点倍率が下がる)

スコアランクに応じて経験値が違う(Sランクで1000点とかかな。最低でも100点は入る)

移調してプレイすると1.3倍ボーナス

経験値テーブルはレベル1-10までは2000点で1レベル上がるくらい。
11-50は5000点で1レベル上がる。
51以降は20000点で1レベル上がる。

全期間のレベルランキングを作成する、
ニックネーム、レベル、会員ランク、クリアレッスン数が表示される。
(同レベルの場合は経験値順)


結果画面に獲得経験値と、ボーナスを表示(ボーナスは後述するがレッスンボーナス、ミッションボーナス、チャレンジボーナスもある)
レベルも表示(45 → 46 Level UP!)のような。
上がらなくても表示


・レッスン
プレミアム、プラチナプランはレッスンをプレイすることができる。(フリー、スタンダードでも数曲プレイ可能、管理画面でプレイ可能レッスンは制御できる。)
マイページ左端にレッスンボタンを用意。

レッスン→コース↛動画&曲という序列になっている。
動画数の制限はない(0でもOK)曲も制限はない(0でもOK)
しかしどちらかは1つは存在しないといけない。

コース一覧にコースの進捗バーを表示。
レッスン一覧では解放されていないレッスンには鍵マーク。
クリアしたレッスンにはクリア日とクリアマーク。

動画はvimeoで埋め込み。

曲は管理画面で追加する。
その曲のクリア条件を管理画面で指定する(キー、再生速度、スコアランク、クリア回数、(楽譜表示設定「ノート+コードorコードのみ」)。レッスンクリア条件テキストとして自動で埋め込む。)

例キー+-0で、再生速度1.0以上で、スコアランクB以上、楽譜表示設定「コードのみ」で10回クリア

すべての曲のクリア条件を達成することで、プレミアムプランでは先のレッスンに進める。

プラチナプランではLINE上で講師とやり取りして提出するような課題があり、その課題説明宿題も管理画面で書く
提出課題のチェックボタンは生徒が押すことができる。
課題提出5日間、のような課題の場合1.2.3.4.5日目のチェックボックスを生徒が埋めていく。


プラチナプランではスキップボタンを押し、レッスンをスキップすることができる。(確認モーダルを出す)
プラチナプランのレッスンの解放状態、完了状態の管理は管理画面から管理者が行うこともできる。
マイページモーダルで進捗を確認することもできる
(例コースドロップダウン→
レッスン1 完了✓・解放✓
レッスン2 完了　・解放✓
レッスン3 完了　・解放✓
レッスン4 完了　・解放
レッスン5 完了　・解放
のように)


プレミアムプランではスキップボタンを押せないように。
レッスンの曲を本番モードでプレイする場合、通常より経験値2倍入る。



・ウィークリーチャレンジ、マンスリーミッションを管理画面で追加できるように
ウィークリーチャレンジ、マンスリーミッション

それぞれ自由に曲、クリア条件(キー、再生速度、スコアランク、クリア回数、(楽譜表示設定「ノート+コードorコードのみ」)を指定し、
レッスンクリア条件テキストとして自動で埋め込む。

マイページにチャレンジ、ミッションは表示されていて、進捗バー(クリア回数 5/10回のように)、が表示される。

チャレンジ、ミッションの達成報酬はそれぞれ翌シーズン経験値1.3倍獲得。

そのシーズンと一つ前シーズンのランキングを表示させる、先着100名まで、フォーマットはレベルランキングと同様のものを使用。
曲は既存の曲の中から選択させるようにし、



・ユーザーのトップページダッシュボード？
ダッシュボードには、お知らせ、チャレンジとミッションが表示される。
お知らせは管理画面で編集できる(リンク付きテキストも可能)


・曲選択の曲一覧をシンプル(今はスペースが大きいかも)
アーティストアルファベット順→曲名アルファベット順。

・結果画面に次にプレイするべきおススメ曲を表示(通常プレイ時、レッスンではない)
ミッション・チャレンジ達成していないならその曲。



・練習日記
ヘッダーにコミュニティタブを用意

そこではその日のユーザーの練習日記が表示される。

練習日記(1日1記事)作成することができる。
編集はとコメントは可能。
他のユーザーはいいねを押すことができる。

ユーザー名をクリックすると、そのユーザーの練習日記ページに飛ぶことができる。

日記で経験値が入るように。



### メモ
- 60FPS維持は最低条件**: `unifiedFrameController` 使用必須、競合ループ禁止!!!!
- Supabase 管理画面 → Schedules → New schedule で `reset-season-multiplier` を定期実行設定

## 2025-01-12: 曲管理システムのデータベース移行

### 実装内容
1. **データベーススキーマの更新**
   - `songs`テーブルに`audio_url`、`xml_url`、`json_url`フィールドを追加
   - `data`フィールドを`json_data`に名前変更（わかりやすくするため）
   - マイグレーションファイル: `supabase/migrations/20250112000000_add_song_file_urls.sql`

2. **Supabaseストレージ統合**
   - `song-files`バケットで曲ファイル（MP3、XML、JSON）を管理
   - ファイルアップロード・削除機能を実装
   - 最大ファイルサイズ: 50MB

3. **管理画面の改善**
   - ファイルアップロードUI追加（ドラッグ&ドロップ対応）
   - アップロード進捗表示
   - ファイルタイプごとのバッジ表示

4. **ゲーム画面の更新**
   - 新しいスキーマに対応
   - ハードコードされた曲（Demo-1）を削除
   - JSONデータはURLまたはインラインの両方に対応

### セットアップ手順
```bash
# 1. マイグレーションを実行
npx supabase db push

# 2. ストレージバケットを作成（サービスロールキーが必要）
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key node scripts/init-storage-buckets.js

# 3. Demo-1楽曲をアップロード
# 管理画面から以下のファイルをアップロード：
# - public/demo-1.json
# - public/demo-1.mp3
# - public/demo-1.xml
```

### 使用方法
1. 管理画面（`/admin`）の「曲管理」セクションにアクセス
2. 必要情報を入力：
   - タイトル（必須）
   - アーティスト（任意）
   - 最低ランク
3. ファイルをアップロード：
   - JSONファイル（必須）：ノーツデータ
   - MP3ファイル（任意）：音源
   - XMLファイル（任意）：楽譜（MusicXML）
4. 「追加」ボタンをクリック

### 技術的詳細
- ファイルは`song-files/{songId}/{fileType}.{ext}`形式で保存
- 公開URLが自動生成され、データベースに保存
- 曲削除時は関連ファイルも自動削除

## 2025-01-12: BPMと難易度フィールドの削除

### 実装内容
1. **データベース制約の修正**
   - `songs`テーブルの`bpm`と`difficulty`フィールドのNOT NULL制約を削除
   - マイグレーションファイル: `supabase/migrations/20250712120806_remove_bpm_difficulty_constraints.sql`

2. **UI更新**
   - 管理画面の曲一覧から難易度表示を削除
   - これらのフィールドは使用しない方針に変更

### 理由
- BPMと難易度の機能は不要との判断
- シンプルな実装を維持するため

## 2025-01-12: asset_urlカラムの削除

### 実装内容
1. **不要なカラムの削除**
   - `songs`テーブルの`asset_url`カラムを削除（古いスキーマの残骸）
   - マイグレーションファイル: `supabase/migrations/20250712121330_remove_asset_url_column.sql`

2. **現在の正しいカラム構成**
   - `audio_url`: MP3ファイルのURL
   - `xml_url`: MusicXMLファイルのURL
   - `json_url`: JSONファイルのURL
   - `json_data`: インラインJSONデータ（json_urlが優先）

### 背景
- 古いマイグレーションまたは手動変更で追加された`asset_url`カラムが残っていた
- 現在のコードベースでは使用されていないため削除

## 2025-01-12: RLSポリシーの追加

### 実装内容
1. **songsテーブルのRLSポリシー追加**
   - 全ユーザーが読み取り可能
   - 管理者（is_admin = true）のみ追加・更新・削除可能
   - マイグレーションファイル: `supabase/migrations/20250712122653_add_songs_rls_policies.sql`

2. **管理者権限の確認**
   - profilesテーブルの`is_admin`フィールドがtrueである必要があります
   - Supabase SQL Editorで以下を実行して確認：
     ```sql
     SELECT id, email, is_admin FROM public.profiles WHERE email = 'your-email@example.com';
     ```

3. **管理者権限の付与（必要な場合）**
   ```sql
   UPDATE public.profiles SET is_admin = true WHERE email = 'your-email@example.com';
   ```

### 背景
- RLSが有効だがポリシーが未定義だったため、すべての操作がブロックされていた
- 適切なセキュリティを保ちながら管理者が曲を管理できるようにした

### 2025-01-21: レッスンリザルトモーダルのXP詳細表示機能

#### 実装内容
- **ResultModal.tsx** を更新: XP詳細表示にレッスンボーナス、速度ボーナス、移調ボーナス、チャレンジ達成ボーナス、契約ランクボーナスを追加
- レッスンモード時は lessonBonusMultiplier を2に設定
- シーズンマルチプライヤーを profile から取得
- チャレンジ/ミッションのボーナスは該当する場合に適用（TODO: 詳細チェック実装）

#### 状態
- ✅ 基本表示完了
- ⚠️ チャレンジ/ミッションの自動検知は追加調査中

### 2025-01-24: レッスンナビゲーション機能実装

#### 実装内容
- **ナビゲーションボタン追加**: レッスン詳細ページに3つのナビゲーションボタンを追加
  - 手前のレッスンに戻る（FaChevronLeft）
  - コースに戻る（FaHome）
  - 次のレッスンに進む（FaChevronRight）
- **ブロック表記の改善**: 「ブロック 1 (レッスン 1-5)」→「ブロック 1」に変更
- **エラーハンドリング実装**:
  - ナビゲーション前のバリデーション機能
  - ブロック境界でのエラーメッセージ表示
  - レッスン解放状態の動的チェック
  - ユーザーフレンドリーなエラーメッセージ

#### 実装ファイル
- `src/utils/lessonNavigation.ts`: ナビゲーション用ユーティリティ関数群
- `src/components/lesson/LessonDetailPage.tsx`: ナビゲーションUI統合
- `src/components/lesson/LessonPage.tsx`: ブロック表記修正

#### 技術仕様
```typescript
interface LessonNavigationInfo {
  previousLesson: Lesson | null;
  nextLesson: Lesson | null;
  canGoPrevious: boolean;
  canGoNext: boolean;
  course: { id: string; hasAccessToPrevious: boolean; hasAccessToNext: boolean; };
}
```

#### 状態
- ✅ ナビゲーションボタンUI実装完了
- ✅ エラーハンドリング実装完了
- ✅ ブロック表記修正完了
- ✅ レスポンシブ対応（モバイル時は短縮表示）
- ✅ レッスンタイトルにレッスン番号表記機能実装完了（2025-01-24追加）

### 2025-01-24: レッスンタイトルにレッスン番号表記機能

#### 実装内容
- **レッスン番号表示**: レッスンタイトルに「レッスン X:」の形式でレッスン番号を表記
- **getLessonBlockInfo関数拡張**: レッスン番号（order_index）の情報を含める機能を追加
- **タイトル表示改善**: LessonDetailPageで「レッスン 1: Introduction to Jazz」のような形式で表示

#### 実装ファイル
- `src/utils/lessonNavigation.ts`: getLessonBlockInfo関数にlessonNumber、lessonDisplayTextプロパティを追加
- `src/components/lesson/LessonDetailPage.tsx`: タイトル表示部分を修正

#### 技術仕様
```typescript
// 拡張されたgetLessonBlockInfo関数の戻り値
{
  blockNumber: number;
  lessonNumber: number;
  displayText: string;           // "ブロック 1"
  lessonDisplayText: string;     // "レッスン 1"
}
```