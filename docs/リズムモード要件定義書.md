要件書: ファンタジーモードへのリズムタイプ追加

本要件書は、既存のファンタジーモードに新機能として「リズムタイプ」を追加するための詳細な仕様を定義するものである。この追加により、ユーザーはリズムに合わせてコードを入力する新しいゲームプレイを体験できるようになり、従来のクイズベースのモード（以下「クイズタイプ」と呼ぶ）と並行して運用される。リズムタイプはさらに「コードランダムパターン」と「コードプログレッションパターン」に分類され、各ステージのゲームタイプ（リズムまたはクイズ）はデータベースで動的に割り当てられる。これにより、ゲームの多様性が高まり、ユーザーのエンゲージメントを向上させることを目的とする。開発にあたっては、既存のファンタジーモードの構造を尊重しつつ、Zustandによる時間管理の統一、MP3ファイルのループ再生、判定タイミングの許容範囲などの共通要件を遵守する。以下では、機能の全体像、詳細仕様、データベース統合、懸念点の解決策を徹底的に説明する。

機能概要

ファンタジーモードは、従来のクイズタイプ（コードを正しく入力して敵を倒すモード）を基盤とし、新たにリズムタイプを追加する形で拡張される。リズムタイプでは、モード開始時にMP3曲が再生され、そのリズム（BPMと拍子に基づくタイミング）に合わせてコードを入力する。入力の成功/失敗により敵への攻撃や防御が決定され、全ての敵のHPを0にするとステージクリアとなる。クイズタイプとリズムタイプの割り当ては、各ステージのデータベースエントリ（game_typeカラム）で管理され、値として"quiz"または"rhythm"が設定される。これにより、ステージごとのゲーム体験を柔軟に制御可能となり、ユーザーは予測不能な多様な挑戦を楽しめる。リズムタイプはさらにサブモードとしてコードランダムパターン（ランダムなコードが出題される）とコードプログレッションパターン（事前定義されたコード進行に沿って出題される）に分かれ、それぞれの挙動がゲームの戦略性を高める。共通して、Zustandによる時間管理を統一し、曲のループ再生（指定小節数まで進んだら2小節目にループ）、判定タイミングの±200ms許容範囲を実装する。失敗時は敵の攻撃ゲージが即座に満タンになり、攻撃を受ける仕組みを採用し、緊張感を維持する。

共通要件の詳細

全てのモード（クイズタイプとリズムタイプ）で共有される要件として、Zustandを活用した時間管理が中心となる。モード開始時にMP3ファイル（demo-1.mp3など）が再生され、クイズタイプでも曲が流れるように拡張する。曲は指定された小節数まで進んだら、1小節目（カウント用）をスキップして2小節目の開始地点にループする（無限リピート）。拍子（3拍子または4拍子）とテンポ（BPM）の概念を導入し、小節数の管理を行う。判定タイミングは前後200msの許容範囲を設定し、この範囲内でコード入力が完成した場合に攻撃成功とする。範囲外または未完成の場合は失敗とし、敵の攻撃ゲージを即座に満タンに到達させる。これにより敵の攻撃が発生し、プレイヤーのHPが減少する。ゲームは全ての敵のHPが0になるまで継続し、プレイヤーのHPが0になるとゲームオーバーとなる。この共通ロジックにより、モード間の移行がスムーズになり、開発効率が向上する。また、懸念点として挙げられた無限リピート時の攻撃ゲージ機能は、Zustandの状態管理で曲のループ時にもゲージの継続性を確保することで解決する。

クイズタイプの概要（既存モードの再定義）

従来のファンタジーモードを「クイズタイプ」と再定義し、リズムタイプとの区別を明確にする。クイズタイプでは、コードが出題され、ユーザーが構成音を正しく入力することで敵にダメージを与える。入力はタイミングを問わず、構成音の完全一致で成功とする。ステージごとのデータベースでgame_type="quiz"が割り当てられた場合にこのモードが起動し、敵の同時出現数はモードに応じて固定される（例: 単体モードでは1体）。この再定義により、既存機能の維持を図りつつ、新モードとの統合を容易にする。

リズムタイプの詳細（新規追加）

リズムタイプは、曲のリズムに同期したコード入力を要求する新しいモードであり、game_type="rhythm"がデータベースで割り当てられたステージで起動する。モード開始時に曲が再生され、ユーザーは拍子とBPMに基づくタイミングでコードを入力する必要がある。判定タイミング内に構成音が全て揃うと成功（敵にダメージ）、失敗すると敵のゲージが満タンになり攻撃を受ける。このモードはさらに「コードランダムパターン」と「コードプログレッションパターン」に分類され、rhythm_patternカラム（"random"または"progression"）で制御される。共通して、曲のループ時に状態がリセットされず無限リピートされるよう設計し、攻撃ゲージの継続性を確保する。コード、小節番号、拍番号（例: 1.5や3.75）のデータをJSONファイルから読み込み、タイミングを計算する。これにより、音楽的な没入感を高め、ユーザーのリズム感を鍛える教育効果も期待される。

コードランダムパターンの詳細

コードランダムパターン（rhythm_pattern="random"）では、出題コードをクイズタイプと同様のallowed_chordsカラムからランダムに選択する。1小節に1回のコードが出題され、敵の同時出現数は固定で1体とする。判定タイミング内にコードが完成すると攻撃成功となり、失敗時は敵のゲージが満タンになる。このパターンは予測不能性を重視し、ユーザーの即時対応力を試す。データベースのallowed_chords JSON配列からコードを抽出し、重複を避けるランダム選択を実装する。

コードプログレッションパターンの詳細

コードプログレッションパターン（rhythm_pattern="progression"）では、chord_progression JSON配列から順番にコードを出題する。敵の同時出現数は固定で4体とし、ABCD列にコードを配置する。コード正解時に次の問題が補充され、補充ロジックはテーブル形式（A B C Dに1-4問目、続いて5-8問目など）で管理する。不正解時の補充は、成功した列に基づき連続した番号を割り当てる（例: 1問目不正解で2問目成功時はB列に6問目）。曲の終わりでループする場合、出題状態はリセットされず、最後のコードの右隣から再開する（無限リピート）。これにより、コード進行の学習を促進する。

データベース統合と割り当て

各ステージのgame_typeカラム（"quiz"または"rhythm"）でモードを割り当て、rhythm_patternカラム（"random"または"progression"）でサブモードを指定する。既存のテーブルにこれらのカラムを追加し、マイグレーションで対応する。measure_count（小節数）、bpm（テンポ）、time_signature（拍子）、loop_measures（ループ開始小節）、chord_progression_data（JSON）などのカラムを活用し、rhythm_data（リズムデータのパス）からタイミング情報を読み込む。これにより、管理者がステージごとにモードを柔軟に設定可能となる。

懸念点と解決策

無限リピート時の攻撃ゲージ機能について、ランダムパターンとプログレッションパターンで懸念されるが、Zustandの時間管理で曲のループ時にもゲージ状態を保持し、タイミングを継続的に計算することで解決する。また、プログレッションパターンの補充ロジックは、列ベースの配列管理で厳密に制御し、ミス時の補充を正しく行う。全体として、既存のクイズタイプとの互換性を保ちつつ、リズムタイプの追加によりゲームの魅力を向上させる。