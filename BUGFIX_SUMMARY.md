# バグ修正サマリー

## 修正した不具合

### 1. カウントイン時の小節表示問題
**問題**: カウントインが1小節の時、M2に1問目が出題されてしまう
**原因**: `timeStore.ts`の`displayMeasure`計算でループ用のモジュロ演算を最初から適用していた
**修正**: 
- 1周目はそのまま小節番号を表示（1, 2, 3...）
- 2周目以降のみループ計算を適用

### 2. ループ時の判定受付問題
**問題**: 曲の最後でループすると、1問目の判定が受け付けられずダメージを受ける
**原因**: 
- ループ時にノーツのヒット状態がリセットされていない
- ループ境界でのタイミング計算が不適切
**修正**:
- `handleTaikoModeInput`でループ時に全ノーツの`isHit`/`isMissed`をリセット
- `updateEnemyGauge`でループ境界のタイミング計算を改善

### 3. 敵の多段ヒット問題
**問題**: ループ時に敵の多段ヒットが発生し、即ゲームオーバーになる
**原因**: 複数の敵が同時にゲージ100%になった時、全員が攻撃していた
**修正**: 
- `updateEnemyGauge`で1回の更新につき1体のみ攻撃するよう制限
- `attackProcessed`フラグで制御

### 4. 怒りアイコン表示問題
**問題**: 敵の攻撃時、怒りアイコンやエフェクトが表示されない
**原因**: 怒り状態の表示時間が500msと短すぎた
**修正**: 
- 表示時間を1500ms（1.5秒）に延長
- `enemyStore`に`reset`関数を追加してゲーム開始時にクリア

### 5. 再挑戦時のノーツ表示問題
**問題**: 再挑戦時やステージセレクト時、ノーツが流れてこないことがある
**原因**: BGMとタイムストアが前回のゲーム状態を保持していた
**修正**:
- `timeStore`に`reset`関数を追加
- `enemyStore`に`reset`関数を追加
- `initializeGame`の最初でBGM停止と各ストアのリセットを実行

## 技術的な改善点

1. **状態管理の改善**: 各ストアにリセット機能を追加し、ゲーム間の状態汚染を防止
2. **タイミング計算の改善**: ループ境界での判定を正確に処理
3. **並行処理の制御**: 同一フレームでの複数攻撃を防止
4. **視覚的フィードバック**: 怒り状態の表示時間を延長してユーザビリティ向上