# ファンタジーモード マルチモンスターシステム デバッグガイド

## 現在の問題

1. **モンスターの重複表示**
   - 敵のUI要素とモンスター画像のx座標が合わない
   - 動いている敵と動かない敵の画像が重なっている状態
   - 攻撃してくるタイミングで1体真ん中から現れる

## 確認された原因

### 1. モンスターの位置計算
- PIXIとUIで同じ位置計算を使用している（25%, 50%, 75%）
- 位置自体は正しく計算されている

### 2. モンスター管理の問題
- `updateActiveMonsters`でスプライトの追加・削除を管理
- 古いスプライトが適切に削除されていない可能性
- 新しいモンスターの追加タイミングが不適切

### 3. モンスター補充のタイミング
- 敵が倒された後に新しいモンスターを補充
- 敵の攻撃タイミングでも処理が走る可能性

## デバッグ手順

### 1. コンソールログの確認
追加したデバッグログで以下を確認：
- `👾 アクティブモンスター更新:` - 現在のモンスター配列
- `📊 現在のスプライト状態:` - PIXIで管理されているスプライト
- `🗑️ モンスター削除:` - 削除されるスプライト
- `✨ 新規モンスター作成:` - 新規作成されるスプライト
- `📍 モンスター位置更新:` - 位置変更
- `🔄 モンスター補充処理:` - モンスター補充時の状況

### 2. 確認すべきポイント
- 同じIDのモンスターが複数存在していないか
- 削除されるべきモンスターが残っていないか
- 新規モンスターの位置が既存モンスターと重複していないか

## 推奨される修正案

### 1. スプライト管理の改善
```typescript
// スプライト削除時により確実な処理
if (monsterData.sprite && !monsterData.sprite.destroyed) {
  monsterData.sprite.visible = false; // まず非表示に
  if (monsterData.sprite.parent) {
    monsterData.sprite.parent.removeChild(monsterData.sprite);
  }
  monsterData.sprite.destroy({ children: true }); // 子要素も含めて破棄
}
```

### 2. モンスター補充タイミングの制御
```typescript
// モンスター補充は倒された直後のみに制限
// 攻撃タイミングでは補充しない
```

### 3. デバッグビューの追加
```typescript
// 各モンスターのIDと位置を画面に表示
// スプライトの境界線を表示
```

## 実装した修正

### 1. デバッグログの追加
- モンスターの追加・削除・更新のタイミングでログを出力
- スプライトの状態を詳細に記録

### 2. スプライト削除処理の改善
- スプライトを非表示にしてから削除
- `destroy({ children: true })` で子要素も含めて完全に破棄
- 孤立したスプライトのクリーンアップ処理を追加

### 3. クリーンアップ処理の強化
- `updateActiveMonsters` で孤立スプライトを検出・削除
- `destroy` メソッドでモンスタースプライトも確実に削除

## 次のステップ

1. **デバッグログの確認**
   - コンソールで追加したログを確認
   - 重複しているモンスターIDがないか確認
   - スプライトの追加・削除が正しく行われているか確認

2. **モンスター補充タイミングの調整**
   - 必要に応じて、攻撃タイミングでの補充を制限
   - モンスターの状態遷移を見直し

3. **モンスター画像の問題**
   - 現在 `/fire.png` を代替画像として使用
   - 適切なモンスター画像を用意して差し替え

4. **さらなる改善**
   - 必要に応じてデバッグビューを追加
   - パフォーマンスの最適化